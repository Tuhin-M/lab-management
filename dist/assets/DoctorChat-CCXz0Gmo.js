import{c as P,r as t,q as R,s as e,a4 as M,a5 as E,a6 as F,O as l,a9 as O,aR as g,J as v,ac as T,x as z,a2 as B}from"./index-TcMYSotV.js";import{S as $}from"./scroll-area-DCyCtquT.js";import{C as L,b as _,d as H,a as Y,c as q}from"./card-P2OsDbbh.js";import{I as J}from"./input-VpsYF4Vr.js";import{V as W}from"./video-ejs4weGF.js";import{S as X}from"./send-TdY4B9LI.js";import{A as S}from"./arrow-left-DUUYJY6r.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=P("VideoOff",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),K=({doctorId:o,doctorName:a,doctorImage:b,onClose:y})=>{const[x,n]=t.useState([]),[d,u]=t.useState(""),[i,D]=t.useState(null),[f,C]=t.useState(!1),[N,k]=t.useState(!1),p=t.useRef(null),j=t.useRef(null),c=t.useRef(null),m=t.useRef(null),h=R.getCurrentUser();t.useEffect(()=>((async()=>{try{const r=await g.createChat(o);D(r.data._id),n(r.data.messages||[])}catch(r){console.error("Failed to initialize chat:",r),v.error("Failed to connect to chat. Please try again.")}})(),()=>{m.current&&m.current.getTracks().forEach(r=>r.stop()),c.current&&c.current.close()}),[o]);const I=async()=>{if(!(!d.trim()||!i))try{k(!0),await g.sendMessage(i,d);const s={_id:Date.now().toString(),sender:{_id:(h==null?void 0:h.id)||"user",name:(h==null?void 0:h.name)||"You",role:"user"},content:d,timestamp:new Date().toISOString()};n([...x,s]),u("");const r=await g.getChatById(i);n(r.data.messages)}catch(s){console.error("Failed to send message:",s),v.error("Failed to send message. Please try again.")}finally{k(!1)}},A=async()=>{try{if(!i)return;const s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});m.current=s,p.current&&(p.current.srcObject=s);const r={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};c.current=new RTCPeerConnection(r),s.getTracks().forEach(w=>{c.current&&c.current.addTrack(w,s)}),c.current.ontrack=w=>{j.current&&w.streams[0]&&(j.current.srcObject=w.streams[0])},v.success(`Starting video call with Dr. ${a}`),C(!0),await g.initiateVideoCall(i)}catch(s){console.error("Failed to start video call:",s),v.error("Could not start video call. Please check your camera and microphone permissions.")}},V=async()=>{try{if(!i)return;m.current&&(m.current.getTracks().forEach(s=>s.stop()),m.current=null),c.current&&(c.current.close(),c.current=null),p.current&&(p.current.srcObject=null),j.current&&(j.current.srcObject=null),C(!1),v.info(`Video call with Dr. ${a} ended`),await g.endVideoCall(i)}catch(s){console.error("Error ending video call:",s)}};return e.jsxs(L,{className:"w-full h-[600px] max-w-2xl mx-auto",children:[e.jsxs(_,{className:"border-b flex flex-row items-center justify-between py-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(M,{children:[e.jsx(E,{src:b,alt:a}),e.jsx(F,{children:a.charAt(0)})]}),e.jsxs("div",{children:[e.jsxs(H,{className:"text-lg",children:["Dr. ",a]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:f?"In video call":"Available for chat"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[f?e.jsx(l,{variant:"destructive",size:"icon",onClick:V,children:e.jsx(G,{className:"h-4 w-4"})}):e.jsx(l,{variant:"secondary",size:"icon",onClick:A,children:e.jsx(W,{className:"h-4 w-4"})}),y&&e.jsx(l,{variant:"ghost",size:"icon",onClick:y,children:e.jsx(O,{className:"h-4 w-4"})})]})]}),e.jsxs(Y,{className:`p-0 flex flex-col ${f?"h-[440px]":"h-[480px]"}`,children:[f&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 p-2 h-52",children:[e.jsxs("div",{className:"relative rounded overflow-hidden bg-gray-200 h-full w-full",children:[e.jsx("video",{ref:j,className:"h-full w-full object-cover",autoPlay:!0,playsInline:!0}),e.jsxs("div",{className:"absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs",children:["Dr. ",a]})]}),e.jsxs("div",{className:"relative rounded overflow-hidden bg-gray-200 h-full w-full",children:[e.jsx("video",{ref:p,className:"h-full w-full object-cover",autoPlay:!0,playsInline:!0,muted:!0}),e.jsx("div",{className:"absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs",children:"You"})]})]}),e.jsx($,{className:`flex-1 p-4 ${f?"h-[250px]":"h-[480px]"}`,children:x.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground text-center",children:e.jsxs("div",{children:[e.jsx("p",{children:"No messages yet"}),e.jsxs("p",{className:"text-sm",children:["Start the conversation with Dr. ",a]})]})}):e.jsx("div",{className:"space-y-4",children:x.map(s=>e.jsx("div",{className:`flex ${s.sender.role==="doctor"?"justify-start":"justify-end"}`,children:e.jsxs("div",{className:`max-w-[80%] px-4 py-2 rounded-lg ${s.sender.role==="doctor"?"bg-secondary text-secondary-foreground":"bg-primary text-primary-foreground"}`,children:[e.jsx("p",{children:s.content}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s._id))})})]}),e.jsx(q,{className:"border-t p-3",children:e.jsxs("form",{className:"flex w-full gap-2",onSubmit:s=>{s.preventDefault(),I()},children:[e.jsx(J,{placeholder:"Type your message...",value:d,onChange:s=>u(s.target.value),disabled:N}),e.jsx(l,{type:"submit",disabled:N||!d.trim(),children:N?e.jsx("span",{className:"h-4 w-4 animate-spin"}):e.jsx(X,{className:"h-4 w-4"})})]})})]})},ce=()=>{const{id:o}=T(),[a,b]=t.useState(null),[y,x]=t.useState(!0),n=z();return t.useEffect(()=>{(async()=>{if(o)try{const u=await B.getDoctorById(o);b(u.data)}catch(u){console.error("Failed to fetch doctor details:",u)}finally{x(!1)}})()},[o]),y?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})}):!a||!o?e.jsxs("div",{className:"container mx-auto p-6",children:[e.jsxs(l,{variant:"ghost",className:"mb-6",onClick:()=>n(-1),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Doctor not found"}),e.jsx("p",{className:"text-muted-foreground",children:"We couldn't find this doctor. Please try again or select another doctor."}),e.jsx(l,{className:"mt-6",onClick:()=>n("/doctors"),children:"Browse Doctors"})]})]}):e.jsx("div",{className:"min-h-screen bg-background pt-16",children:e.jsxs("div",{className:"container mx-auto p-4 md:p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(l,{variant:"ghost",onClick:()=>n(-1),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Back"]})}),e.jsxs("div",{className:"max-w-2xl mx-auto mb-8",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-2",children:["Chat with Dr. ",a.name]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Use the chat below to communicate with your doctor. You can also start a video consultation if needed."}),e.jsx(K,{doctorId:o,doctorName:a.name,doctorImage:a.image}),e.jsx("div",{className:"mt-6 text-center text-sm text-muted-foreground",children:e.jsx("p",{children:"Need help? Contact our support team at support@ekitsa.com"})})]})]})})};export{ce as default};
