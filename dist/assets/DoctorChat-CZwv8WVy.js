import{c as D,r as s,w as M,s as e,B as i,_ as R,ah as g,E as v,a0 as E,q as F,ai as T}from"./index-DgBcbMcU.js";import{S as z}from"./scroll-area-7n1pLac5.js";import{C as B,a as O,b as $,c as _,d as L}from"./card-CEAmbz21.js";import{I as H}from"./input-CJYTmRyd.js";import{A as Y,a as q,b as W}from"./avatar-BDMxoNeQ.js";import{V as X}from"./video-BT-xMeTo.js";import{A as S}from"./arrow-left-BhfpUSqy.js";import"./index-C06rPHWt.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=D("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=D("VideoOff",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),K=({doctorId:o,doctorName:a,doctorImage:b,onClose:y})=>{const[x,n]=s.useState([]),[d,u]=s.useState(""),[l,I]=s.useState(null),[f,C]=s.useState(!1),[N,k]=s.useState(!1),p=s.useRef(null),j=s.useRef(null),c=s.useRef(null),m=s.useRef(null),h=M.getCurrentUser();s.useEffect(()=>((async()=>{try{const r=await g.createChat(o);I(r.data._id),n(r.data.messages||[])}catch(r){console.error("Failed to initialize chat:",r),v.error("Failed to connect to chat. Please try again.")}})(),()=>{m.current&&m.current.getTracks().forEach(r=>r.stop()),c.current&&c.current.close()}),[o]);const A=async()=>{if(!(!d.trim()||!l))try{k(!0),await g.sendMessage(l,d);const t={_id:Date.now().toString(),sender:{_id:(h==null?void 0:h.id)||"user",name:(h==null?void 0:h.name)||"You",role:"user"},content:d,timestamp:new Date().toISOString()};n([...x,t]),u("");const r=await g.getChatById(l);n(r.data.messages)}catch(t){console.error("Failed to send message:",t),v.error("Failed to send message. Please try again.")}finally{k(!1)}},V=async()=>{try{if(!l)return;const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});m.current=t,p.current&&(p.current.srcObject=t);const r={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};c.current=new RTCPeerConnection(r),t.getTracks().forEach(w=>{c.current&&c.current.addTrack(w,t)}),c.current.ontrack=w=>{j.current&&w.streams[0]&&(j.current.srcObject=w.streams[0])},v.success(`Starting video call with Dr. ${a}`),C(!0),await g.initiateVideoCall(l)}catch(t){console.error("Failed to start video call:",t),v.error("Could not start video call. Please check your camera and microphone permissions.")}},P=async()=>{try{if(!l)return;m.current&&(m.current.getTracks().forEach(t=>t.stop()),m.current=null),c.current&&(c.current.close(),c.current=null),p.current&&(p.current.srcObject=null),j.current&&(j.current.srcObject=null),C(!1),v.info(`Video call with Dr. ${a} ended`),await g.endVideoCall(l)}catch(t){console.error("Error ending video call:",t)}};return e.jsxs(B,{className:"w-full h-[600px] max-w-2xl mx-auto",children:[e.jsxs(O,{className:"border-b flex flex-row items-center justify-between py-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Y,{children:[e.jsx(q,{src:b,alt:a}),e.jsx(W,{children:a.charAt(0)})]}),e.jsxs("div",{children:[e.jsxs($,{className:"text-lg",children:["Dr. ",a]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:f?"In video call":"Available for chat"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[f?e.jsx(i,{variant:"destructive",size:"icon",onClick:P,children:e.jsx(J,{className:"h-4 w-4"})}):e.jsx(i,{variant:"secondary",size:"icon",onClick:V,children:e.jsx(X,{className:"h-4 w-4"})}),y&&e.jsx(i,{variant:"ghost",size:"icon",onClick:y,children:e.jsx(R,{className:"h-4 w-4"})})]})]}),e.jsxs(_,{className:`p-0 flex flex-col ${f?"h-[440px]":"h-[480px]"}`,children:[f&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 p-2 h-52",children:[e.jsxs("div",{className:"relative rounded overflow-hidden bg-gray-200 h-full w-full",children:[e.jsx("video",{ref:j,className:"h-full w-full object-cover",autoPlay:!0,playsInline:!0}),e.jsxs("div",{className:"absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs",children:["Dr. ",a]})]}),e.jsxs("div",{className:"relative rounded overflow-hidden bg-gray-200 h-full w-full",children:[e.jsx("video",{ref:p,className:"h-full w-full object-cover",autoPlay:!0,playsInline:!0,muted:!0}),e.jsx("div",{className:"absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs",children:"You"})]})]}),e.jsx(z,{className:`flex-1 p-4 ${f?"h-[250px]":"h-[480px]"}`,children:x.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground text-center",children:e.jsxs("div",{children:[e.jsx("p",{children:"No messages yet"}),e.jsxs("p",{className:"text-sm",children:["Start the conversation with Dr. ",a]})]})}):e.jsx("div",{className:"space-y-4",children:x.map(t=>e.jsx("div",{className:`flex ${t.sender.role==="doctor"?"justify-start":"justify-end"}`,children:e.jsxs("div",{className:`max-w-[80%] px-4 py-2 rounded-lg ${t.sender.role==="doctor"?"bg-secondary text-secondary-foreground":"bg-primary text-primary-foreground"}`,children:[e.jsx("p",{children:t.content}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},t._id))})})]}),e.jsx(L,{className:"border-t p-3",children:e.jsxs("form",{className:"flex w-full gap-2",onSubmit:t=>{t.preventDefault(),A()},children:[e.jsx(H,{placeholder:"Type your message...",value:d,onChange:t=>u(t.target.value),disabled:N}),e.jsx(i,{type:"submit",disabled:N||!d.trim(),children:N?e.jsx("span",{className:"h-4 w-4 animate-spin"}):e.jsx(G,{className:"h-4 w-4"})})]})})]})},oe=()=>{const{id:o}=E(),[a,b]=s.useState(null),[y,x]=s.useState(!0),n=F();return s.useEffect(()=>{(async()=>{if(o)try{const u=await T.getDoctorById(o);b(u.data)}catch(u){console.error("Failed to fetch doctor details:",u)}finally{x(!1)}})()},[o]),y?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})}):!a||!o?e.jsxs("div",{className:"container mx-auto p-6",children:[e.jsxs(i,{variant:"ghost",className:"mb-6",onClick:()=>n(-1),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Doctor not found"}),e.jsx("p",{className:"text-muted-foreground",children:"We couldn't find this doctor. Please try again or select another doctor."}),e.jsx(i,{className:"mt-6",onClick:()=>n("/doctors"),children:"Browse Doctors"})]})]}):e.jsxs("div",{className:"container mx-auto p-4 md:p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(i,{variant:"ghost",onClick:()=>n(-1),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Back"]})}),e.jsxs("div",{className:"max-w-2xl mx-auto mb-8",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-2",children:["Chat with Dr. ",a.name]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Use the chat below to communicate with your doctor. You can also start a video consultation if needed."}),e.jsx(K,{doctorId:o,doctorName:a.name,doctorImage:a.image}),e.jsx("div",{className:"mt-6 text-center text-sm text-muted-foreground",children:e.jsx("p",{children:"Need help? Contact our support team at support@ekitsa.com"})})]})]})};export{oe as default};
