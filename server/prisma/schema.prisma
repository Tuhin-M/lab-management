generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  DOCTOR
  LAB_OWNER
  ADMIN
  STAFF
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
}

enum BookingStatus {
  BOOKED
  SAMPLE_COLLECTED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum RecordType {
  prescription
  test_result
  health_metric
  doctor_note
}

model User {
  id            String         @id @default(uuid())
  name          String
  email         String         @unique
  password      String
  phone         String?
  address       Json?          // { street, city, state, zipCode }
  role          UserRole       @default(PATIENT)
  refreshToken  String?
  lastLogin     DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  appointments  Appointment[]
  testBookings  TestBooking[]
  healthRecords HealthRecord[]
  blogPosts     BlogPost[]
  labs          Lab[]          @relation("LabOwners")
  reviews       Review[]
  comments      Comment[]
}

model Specialty {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String   @default("default-specialty.png")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  doctors     Doctor[]
}

model Doctor {
  id              String        @id @default(uuid())
  name            String
  specialtyId     String
  specialty       Specialty     @relation(fields: [specialtyId], references: [id])
  qualifications  String[]
  experience      Int
  hospital        String
  address         Json?         // { street, city, state, zipCode }
  consultationFee Float
  availableSlots  Json[]        // [{ day, startTime, endTime }]
  rating          Float         @default(0)
  image           String        @default("default-doctor.jpg")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  appointments    Appointment[]
  reviews         Review[]      @relation("DoctorReviews")
}

model Lab {
  id              String        @id @default(uuid())
  name            String
  description     String
  address         Json?         // { street, city, state, zipCode }
  contactInfo     Json?         // { phone, email, website }
  certifications  String[]
  operatingHours  Json?         // { weekdays: { open, close }, weekends: { open, close } }
  image           String        @default("default-lab.jpg")
  rating          Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  owners          User[]        @relation("LabOwners")
  tests           Test[]        @relation("LabTests")
  testBookings    TestBooking[]
  reviews         Review[]      @relation("LabReviews")
}

model Category {
  id               String     @id @default(uuid())
  name             String     @unique
  description      String?
  parentCategoryId String?
  parentCategory   Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  Category[] @relation("CategoryHierarchy")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  tests            Test[]
}

model Test {
  id                String        @id @default(uuid())
  name              String
  description       String
  categoryId        String
  category          Category      @relation(fields: [categoryId], references: [id])
  price             Float
  preparationNeeded String        @default("No special preparation required")
  timeRequired      String        @default("1 day")
  reportTime        String        @default("24 hours")
  homeCollection    Boolean       @default(false)
  homeCollectionFee Float         @default(0)
  popularity        Int           @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  labs              Lab[]         @relation("LabTests")
  bookings          BookingTest[]
}

model Appointment {
  id             String            @id @default(uuid())
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  doctorId       String
  doctor         Doctor            @relation(fields: [doctorId], references: [id])
  date           DateTime
  timeSlot       String
  status         AppointmentStatus @default(SCHEDULED)
  reasonForVisit String
  notes          String?
  paymentStatus  PaymentStatus     @default(PENDING)
  paymentAmount  Float
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
}

model TestBooking {
  id                   String        @id @default(uuid())
  userId               String
  user                 User          @relation(fields: [userId], references: [id])
  labId                String
  lab                  Lab           @relation(fields: [labId], references: [id])
  tests                BookingTest[]
  bookingDate          DateTime
  sampleCollectionDate DateTime
  sampleCollectionTime String
  homeCollection       Boolean       @default(false)
  status               BookingStatus @default(BOOKED)
  patientDetails       Json?         // { name, age, gender, phone, email, address: { street, city, state, zipCode } }
  prescriptionImage    String?
  paymentStatus        PaymentStatus @default(PENDING)
  totalAmount          Float
  reportUrl            String?
  reportUploadedAt     DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}

model BookingTest {
  id            String      @id @default(uuid())
  testBookingId String
  testBooking   TestBooking @relation(fields: [testBookingId], references: [id])
  testId        String
  test          Test        @relation(fields: [testId], references: [id])
  price         Float
}

model HealthRecord {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  recordType   RecordType
  title        String
  date         DateTime   @default(now())
  doctorName   String?
  hospitalName String?
  description  String?
  fileUrl      String?
  metrics      Json?      // { height, weight, bloodPressure, bloodSugar, cholesterol }
  tags         String[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model BlogPost {
  id          String    @id @default(uuid())
  title       String
  content     String
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
  category    String
  tags        String[]
  coverImage  String    @default("default-blog.jpg")
  readTime    Int       @default(5)
  views       Int       @default(0)
  isPublished Boolean   @default(true)
  publishedAt DateTime  @default(now()) @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt
  comments    Comment[]
}

model Comment {
  id         String   @id @default(uuid())
  blogPostId String
  blogPost   BlogPost @relation(fields: [blogPostId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  text       String
  createdAt  DateTime @default(now())
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  doctorId  String?
  doctor    Doctor?  @relation("DoctorReviews", fields: [doctorId], references: [id])
  labId     String?
  lab       Lab?     @relation("LabReviews", fields: [labId], references: [id])
  text      String
  rating    Int
  createdAt DateTime @default(now())
}

// ============================================
// NEW MODELS FOR PHASE 2: Lab Booking MVP
// ============================================

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Coupon {
  id              String       @id @default(uuid())
  code            String       @unique
  description     String?
  discountType    DiscountType @default(PERCENTAGE)
  discountValue   Float        // percentage (0-100) or fixed amount
  minOrderValue   Float        @default(0)
  maxDiscount     Float?       // max discount cap for percentage coupons
  validFrom       DateTime     @default(now())
  validUntil      DateTime
  usageLimit      Int?         // null = unlimited
  usedCount       Int          @default(0)
  isActive        Boolean      @default(true)
  applicableTests String[]     // empty = all tests
  applicableLabs  String[]     // empty = all labs
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

enum PaymentMethod {
  UPI
  CARD
  NET_BANKING
  COD
  WALLET
}

model PaymentTransaction {
  id              String        @id @default(uuid())
  testBookingId   String?
  appointmentId   String?
  userId          String
  amount          Float
  currency        String        @default("INR")
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus @default(PENDING)
  gatewayOrderId  String?       // Razorpay/Stripe order ID
  gatewayPaymentId String?      // Razorpay/Stripe payment ID
  couponCode      String?
  discountAmount  Float         @default(0)
  taxAmount       Float         @default(0)
  finalAmount     Float
  metadata        Json?         // additional payment details
  failureReason   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// ============================================
// PHASE 3: Doctor Portal & Telemedicine
// ============================================

enum ConsultationMode {
  VIDEO
  VOICE
  CHAT
  IN_PERSON
}

enum SessionStatus {
  SCHEDULED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model TeleSession {
  id              String            @id @default(uuid())
  appointmentId   String            @unique
  patientId       String
  doctorId        String
  mode            ConsultationMode
  status          SessionStatus     @default(SCHEDULED)
  scheduledAt     DateTime
  startedAt       DateTime?
  endedAt         DateTime?
  duration        Int?              // in minutes
  roomId          String?           // for video/voice calls
  chatHistory     Json[]            // chat messages
  notes           String?           // doctor's notes from session
  recordingUrl    String?           // optional recording
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model Prescription {
  id              String   @id @default(uuid())
  appointmentId   String?
  teleSessionId   String?
  patientId       String
  doctorId        String
  doctorName      String
  patientName     String
  diagnosis       String?
  symptoms        String[]
  medications     Json[]   // [{ name, dosage, frequency, duration, instructions }]
  tests           String[] // recommended tests
  advice          String?
  followUpDate    DateTime?
  isDigital       Boolean  @default(true)
  signature       String?  // doctor's digital signature
  pdfUrl          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
